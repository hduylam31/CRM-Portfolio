<!DOCTYPE html>
<html lang="vi"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Segmentation - Phân khúc</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>

    :root{
      --primary-blue:#0f172a;
      --accent-blue:#3b82f6;
      --bg-light:#f8fafc;
      --card-white:#ffffff;
      --text-main:#334155;
      --text-muted:#64748b;
      --border-color:#e2e8f0;
      --success:#10b981;
      --danger:#ef4444;
      --warning:#f59e0b;
      --purple:#6d28d9;
      --shadow: 0 12px 24px rgba(0,0,0,0.06);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:'Inter', sans-serif;
      background: var(--bg-light);
      color: var(--text-main);
    }

    /* Page wrapper (works inside iframe) */
    .page{
      padding: 1.25rem;
      max-width: 1680px;
      margin: 0 auto;
    }

    /* Header */
    .page-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    .page-title{
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .page-title h1{
      margin:0;
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-blue);
      letter-spacing: 0.2px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .page-title p{
      margin:0;
      font-size: .85rem;
      color: var(--text-muted);
      line-height: 1.4;
    }
    .crumbs{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 2px;
    }
    .crumb{
      font-size:.72rem;
      color: var(--text-muted);
      background: #fff;
      border:1px solid var(--border-color);
      padding: 6px 10px;
      border-radius: 999px;
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .pill{
      font-size: .7rem;
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 700;
      border: 1px solid transparent;
      display:inline-flex;
      align-items:center;
      gap: 6px;
    }
    .pill.blue{ background:#e0f2fe; color:#0369a1; border-color:#bae6fd; }
    .pill.green{ background:#dcfce7; color:#15803d; border-color:#bbf7d0; }
    .pill.yellow{ background:#fef9c3; color:#a16207; border-color:#fde68a; }
    .pill.red{ background:#fee2e2; color:#b91c1c; border-color:#fecaca; }
    .pill.purple{ background:#ede9fe; color:#5b21b6; border-color:#ddd6fe; }
    .pill.gray{ background:#f1f5f9; color:#475569; border-color:#e2e8f0; }

    .actions{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .btn{
      border: 1px solid var(--border-color);
      background: #fff;
      color: var(--text-main);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 700;
      font-size: .85rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      transition: .2s;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,0.06); border-color:#cbd5e1; }
    .btn.primary{
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: #fff;
    }
    .btn.primary:hover{ box-shadow: 0 14px 26px rgba(59,130,246,0.22); }
    .btn.ghost{
      background: transparent;
      border-color: transparent;
      color: var(--text-muted);
    }
    .btn.ghost:hover{ transform:none; box-shadow:none; background:#fff; border-color: var(--border-color); color: var(--text-main); }

    /* Stats */
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .stat{
      background:#fff;
      border:1px solid var(--border-color);
      border-radius: 16px;
      padding: 1rem;
      display:flex;
      align-items:center;
      gap: 12px;
      min-height: 86px;
    }
    .stat-ic{
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 1.05rem;
      flex: 0 0 auto;
    }
    .stat h6{ margin:0 0 4px 0; font-size: .75rem; color: var(--text-muted); font-weight: 700; letter-spacing: .2px; text-transform: uppercase; }
    .stat .val{ font-size: 1.25rem; font-weight: 700; color: var(--primary-blue); line-height: 1; }
    .stat .sub{ margin-top: 6px; font-size: .78rem; color: var(--text-muted); display:flex; align-items:center; gap: 6px; }

    /* Filter bar */
    .card{
      background:#fff;
      border:1px solid var(--border-color);
      border-radius: 16px;
    }
    .filters{
      padding: 1rem;
      display:grid;
      grid-template-columns: 1.4fr 1fr 1fr 1fr 1fr;
      gap: 10px;
      align-items:center;
      margin-bottom: 1rem;
    }
    .field{
      position:relative;
    }
    .field label{
      display:block;
      font-size: .72rem;
      color: var(--text-muted);
      font-weight: 700;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: .25px;
    }
    .input, select{
      width:100%;
      padding: 11px 12px;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      outline:none;
      background: #fff;
      font-size: .88rem;
      color: var(--text-main);
    }
    .input:focus, select:focus{
      border-color: rgba(59,130,246,0.6);
      box-shadow: 0 0 0 4px rgba(59,130,246,0.15);
    }
    .input.with-ic{ padding-left: 36px; }
    .field .ic{
      position:absolute;
      left: 12px;
      top: 36px;
      color: var(--text-muted);
      font-size: .95rem;
    }

    /* Multi-select (same UX spirit as your status dropdown mẫu) */
    .multi-select{ width:100%; position:relative; 
      width:100%;
      position:relative;
      user-select:none;
    }
    .multi-select .selected-options{
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 11px 44px 11px 12px;
      background:#fff;
      font-size: .88rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      min-height: 42px;
    }
    .multi-select .dropdown-icon{
      position:absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      pointer-events:none;
    }
    .multi-select .options-list{
      position:absolute;
      top: calc(100% + 8px);
      left:0;
      right:0;
      background:#fff;
      border:1px solid var(--border-color);
      border-radius: 14px;
      padding: 10px;
      box-shadow: var(--shadow);
      display:none;
      z-index: 20;
      max-height: 240px;
      overflow:auto;
    }
    .multi-select.open .options-list{ display:block; }
    .options-list label{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-size: .88rem;
      color: var(--text-main);
      text-transform:none;
      letter-spacing: 0;
      font-weight: 600;
      margin:0;
    }
    .options-list label:hover{ background:#f8fafc; }
    .options-list input{ transform: translateY(1px); }

    /* Layout: list + preview */
    .grid{
      display:grid;
      grid-template-columns: 2.05fr 0.95fr;
      gap: 1rem;
    }
    .panel{
      padding: 1rem;
    }

    /* Table */
    .table-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 1rem;
      padding: 1rem 1rem 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .table-head h3{
      margin:0;
      font-size: .95rem;
      font-weight: 700;
      color: var(--primary-blue);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .table-head .meta{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
      color: var(--text-muted);
      font-size: .82rem;
      font-weight: 600;
    }
    .table-wrap{ overflow:auto; }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      font-size: .88rem;
    }
    thead th{
      text-align:left;
      padding: 10px 12px;
      color: var(--text-muted);
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .25px;
      font-weight: 700;
      border-bottom: 1px solid var(--border-color);
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid var(--border-color);
      vertical-align: top;
    }
    tbody tr{
      cursor:pointer;
      transition: .15s;
    }
    tbody tr:hover{
      background: #f8fafc;
    }
    tbody tr.active{
      background: rgba(59,130,246,0.08);
      outline: 1px solid rgba(59,130,246,0.25);
    }
    .id{
      font-weight: 700;
      color: var(--primary-blue);
    }
    .subline{
      margin-top: 4px;
      color: var(--text-muted);
      font-size: .8rem;
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    /* Preview */
    .preview-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
    }
    .preview-top h3{
      margin:0;
      font-size: .95rem;
      font-weight: 700;
      color: var(--primary-blue);
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .mini-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .icon-btn{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background:#fff;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--text-muted);
      transition: .2s;
    }
    .icon-btn:hover{
      border-color:#cbd5e1;
      color: var(--text-main);
      box-shadow: 0 10px 18px rgba(0,0,0,0.06);
      transform: translateY(-1px);
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 1rem;
    }
    .kv .item{
      border:1px dashed var(--border-color);
      border-radius: 14px;
      padding: 10px 12px;
      background:#fff;
    }
    .kv .k{ font-size:.72rem; color: var(--text-muted); font-weight: 700; text-transform: uppercase; letter-spacing: .25px; }
    .kv .v{ margin-top: 6px; font-size: .88rem; font-weight: 700; color: var(--primary-blue); display:flex; align-items:center; gap: 8px; flex-wrap: wrap; }

    .section{
      padding: 0 1rem 1rem 1rem;
    }
    .section h4{
      margin: 0.25rem 0 0.75rem 0;
      font-size: .78rem;
      color: var(--text-muted);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .25px;
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .note{
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
      color: var(--text-main);
      font-size: .88rem;
      line-height: 1.5;
    }
    .timeline{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .t-item{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border-color);
      background:#fff;
    }
    .t-dot{
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--accent-blue);
      margin-top: 5px;
      flex: 0 0 auto;
    }
    .t-content{ flex: 1 1 auto; }
    .t-content .t-top{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }
    .t-content .who{
      font-weight: 700;
      font-size: .85rem;
      color: var(--primary-blue);
    }
    .t-content .when{
      font-size: .78rem;
      color: var(--text-muted);
      font-weight: 600;
    }
    .t-content .msg{
      font-size: .86rem;
      color: var(--text-main);
      line-height: 1.45;
    }

    /* Responsive */
    @media (max-width: 1100px){
      .filters{ grid-template-columns: 1fr 1fr; }
      .stats{ grid-template-columns: 1fr 1fr; }
      .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 560px){
      .page{ padding: 0.9rem; }
      .filters{ grid-template-columns: 1fr; }
      .stats{ grid-template-columns: 1fr; }
      .actions{ justify-content:flex-start; }
    }

    /* Segmentation additions */
.modal{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 1rem;
      z-index: 100;
    }

.modal-card{
      width: min(1120px, 100%);
      background:#fff;
      border-radius: 18px;
      border:1px solid var(--border-color);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

.modal-head{
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }

.modal-body{ padding: 1rem; }

.modal-foot{
      padding: 1rem;
      border-top: 1px solid var(--border-color);
      display:flex;
      justify-content:flex-end;
      gap: 10px;
      flex-wrap: wrap;
    }

.modal-grid{
      display:grid;
      grid-template-columns: 1.5fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
      align-items:end;
    }

.pick-list{
      border:1px solid var(--border-color);
      border-radius: 14px;
      overflow:auto;
      max-height: 360px;
    }

.pick-row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      cursor:pointer;
    }

.hint{
      font-size:.82rem;
      color: var(--text-muted);
      font-weight: 650;
      display:flex;
      align-items:center;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

.th-name{ min-width: 520px; }

td.name-cell .name-title{
      display:block;
      font-weight: 700;
      color: var(--primary-blue);
      line-height: 1.25;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }

.name-title{
      display:block;
      font-weight: 700;
      color: var(--primary-blue);
      line-height: 1.25;
      display:-webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow:hidden;
    }


  </style>
</head>

<body>
  <div class="page">
    <!-- Header -->
    <div class="page-head">
      <div class="page-title">
        <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:2px;">
          <a class="btn" href="index.html" style="text-decoration:none;"><i class="fa-solid fa-arrow-left"></i> Quay lại</a>
          <span class="pill gray"><i class="fa-solid fa-bullhorn"></i> Marketing</span>
          <span class="pill blue"><i class="fa-solid fa-diagram-project"></i> Segmentation</span>
        </div>

        <h1><i class="fa-solid fa-diagram-project" style="color:var(--accent-blue)"></i> Phân khúc khách hàng</h1>
        <p>Tạo phân khúc theo hành vi / doanh thu / khu vực để dùng cho chiến dịch ZNS/Email/SMS và CRM Automation.</p>

        <div class="crumbs">
          <div class="crumb"><i class="fa-solid fa-layer-group"></i> Marketing</div>
          <div class="crumb"><i class="fa-solid fa-diagram-project"></i> Segments</div>
          <div class="crumb" id="crumbLive"><i class="fa-solid fa-circle-info"></i> Chọn 1 segment để xem nhanh</div>
        </div>
      </div>

      <div class="actions">
        <button class="btn ghost" id="btnRefresh"><i class="fa-solid fa-rotate"></i> Làm mới</button>
        <button class="btn" data-action="segment_export" id="btnExport"><i class="fa-solid fa-file-arrow-down"></i> Export</button>
        <button class="btn" data-action="segment_import" id="btnImport"><i class="fa-solid fa-file-arrow-up"></i> Import</button>
        <button class="btn" data-action="segment_rules" id="btnRules"><i class="fa-solid fa-filter-circle-dollar"></i> Rules</button>
        <button class="btn primary" data-action="segment_new" id="btnNew"><i class="fa-solid fa-plus"></i> Tạo Segment</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat">
        <div class="stat-ic" style="background:#e0f2fe;color:#0369a1"><i class="fa-solid fa-layer-group"></i></div>
        <div>
          <h6>Segments</h6>
          <div class="val" id="statSegments">—</div>
          <div class="sub"><i class="fa-solid fa-bolt"></i> <span id="statActiveSub">Active: —</span></div>
        </div>
      </div>
      <div class="stat">
        <div class="stat-ic" style="background:#dcfce7;color:#15803d"><i class="fa-solid fa-users"></i></div>
        <div>
          <h6>Total members</h6>
          <div class="val" id="statMembers">—</div>
          <div class="sub"><i class="fa-solid fa-arrow-trend-up"></i> <span id="statMembersSub">7 ngày: —</span></div>
        </div>
      </div>
      <div class="stat">
        <div class="stat-ic" style="background:#fee2e2;color:#b91c1c"><i class="fa-solid fa-triangle-exclamation"></i></div>
        <div>
          <h6>Needs refresh</h6>
          <div class="val" id="statStale">—</div>
          <div class="sub"><i class="fa-regular fa-clock"></i> <span id="statStaleSub">&gt; 24h: —</span></div>
        </div>
      </div>
      <div class="stat">
        <div class="stat-ic" style="background:#ede9fe;color:#5b21b6"><i class="fa-solid fa-paper-plane"></i></div>
        <div>
          <h6>Ready for campaign</h6>
          <div class="val" id="statReady">—</div>
          <div class="sub"><i class="fa-solid fa-wand-magic-sparkles"></i> <span id="statReadySub">Có rule: —</span></div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="card filters">
      <div class="field">
        <label>Tìm kiếm</label>
        <i class="fa-solid fa-magnifying-glass ic"></i>
        <input id="q" class="input with-ic" placeholder="SEG-xxx, tên segment, tag...">
      </div>

      <div class="field">
        <label>Trạng thái</label>
        <div class="multi-select" id="statusDropdown">
          <div class="selected-options" id="statusSelected">Tất cả</div>
          <div class="dropdown-icon"><i class="fas fa-chevron-down"></i></div>
          <div class="options-list" id="statusOptions">
            <label><input type="checkbox" value="Active" checked=""> Active</label>
            <label><input type="checkbox" value="Draft" checked=""> Draft</label>
            <label><input type="checkbox" value="Paused" checked=""> Paused</label>
            <label><input type="checkbox" value="Archived" checked=""> Archived</label>
          </div>
        </div>
      </div>

      <div class="field">
        <label>Kiểu segment</label>
        <select id="type">
          <option value="">Tất cả</option>
          <option selected="">Dynamic (Rule-based)</option>
          <option>Static (Manual list)</option>
        </select>
      </div>

      <div class="field">
        <label>Nguồn dữ liệu</label>
        <select id="source">
          <option value="">Tất cả</option>
          <option selected="">CRM</option>
          <option>E-commerce</option>
          <option>POS</option>
          <option>Import</option>
        </select>
      </div>

      <div class="field">
        <label>Refresh</label>
        <select id="refresh">
          <option value="all" selected="">Tất cả</option>
          <option value="fresh">&lt; 24h</option>
          <option value="stale">&gt; 24h</option>
        </select>
      </div>
    </div>

    <!-- Main grid -->
    <div class="grid">
      <!-- List -->
      <div class="card">
        <div class="table-head">
          <h3><i class="fa-solid fa-list-check" style="color:var(--accent-blue)"></i> Danh sách Segments</h3>
          <div class="meta">
            <span id="resultCount">—</span>
            <span>•</span>
            <span id="lastSync"><i class="fa-regular fa-clock"></i> —</span>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:120px">Segment</th>
                <th class="th-name">Name</th>
                <th style="width:130px">Type</th>
                <th style="width:120px">Status</th>
                <th style="width:130px">Members</th>
                <th style="width:140px">Last refresh</th>
                <th style="width:110px">Actions</th>
              </tr>
            </thead>
            <tbody id="segTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Preview -->
      <div class="card">
        <div class="preview-top">
          <h3><i class="fa-solid fa-bolt" style="color:var(--warning)"></i> Quick Preview</h3>
          <div class="mini-actions">
            <button class="icon-btn" title="Tạo campaign" data-action="create_campaign"><i class="fa-solid fa-paper-plane"></i></button>
            <button class="icon-btn" title="Làm mới segment" data-action="refresh_segment"><i class="fa-solid fa-rotate"></i></button>
            <button class="icon-btn" title="Xem chi tiết" data-action="segment_view"><i class="fa-solid fa-eye"></i></button>
          </div>
        </div>

        <div class="kv">
          <div class="item">
            <div class="k">Segment</div>
            <div class="v" id="pvId">—</div>
          </div>
          <div class="item">
            <div class="k">Status</div>
            <div class="v" id="pvStatus">—</div>
          </div>
          <div class="item">
            <div class="k">Type</div>
            <div class="v" id="pvType">—</div>
          </div>
          <div class="item">
            <div class="k">Members</div>
            <div class="v" id="pvMembers">—</div>
          </div>
          <div class="item">
            <div class="k">Source</div>
            <div class="v" id="pvSource">—</div>
          </div>
          <div class="item">
            <div class="k">Refresh</div>
            <div class="v" id="pvRefresh">—</div>
          </div>
        </div>

        <div class="section">
          <h4><i class="fa-regular fa-note-sticky"></i> Mô tả</h4>
          <div class="note" id="pvDesc">Chọn 1 segment ở bảng bên trái để xem nội dung.</div>
        </div>

        <div class="section">
          <h4><i class="fa-solid fa-sliders"></i> Rule snapshot</h4>
          <div class="note" id="pvRule" style="background:#f0f7ff;border-color:#bae6fd;color:#0b3b7b">
            • Ví dụ: LTV ≥ 5,000,000 AND Last purchase ≤ 60 days AND City IN (HCM, HN)
          </div>
          <div class="hint"><i class="fa-solid fa-circle-info"></i> Rule chi tiết sẽ mở trong <b>segmentation_detail.html</b> hoặc <b>segment_rules.html</b>.</div>
        </div>

        <div class="section">
          <h4><i class="fa-solid fa-clock-rotate-left"></i> Hoạt động gần đây</h4>
          <div class="mini-list" id="pvTimeline">
            <div class="mini-item">
              <div class="mini-dot"></div>
              <div class="mini-content">
                <div class="top">
                  <div class="who">Hệ thống</div>
                  <div class="when">—</div>
                </div>
                <div class="msg">Chưa có dữ liệu — hãy chọn 1 segment.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="section">
          <h4><i class="fa-solid fa-wand-magic-sparkles"></i> Gợi ý hành động</h4>
          <div class="note" id="pvHint">
            • Ưu tiên segment có <b>Dynamic rule</b> để tự cập nhật members<br>
            • Khi chuẩn bị chạy campaign: kiểm tra opt-in, blacklist và quota gửi
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Export -->
  <div class="modal" id="exportModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3><i class="fa-solid fa-file-arrow-down" style="color:var(--accent-blue)"></i> Export Segment Members</h3>
        <button class="btn ghost" data-action="close_modal"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="modal-body">
        <div class="modal-grid">
          <div class="field" style="margin:0;">
            <label>Segment</label>
            <input class="input" id="exSegment" value="—" readonly="">
            <div class="hint"><i class="fa-solid fa-circle-info"></i> Export danh sách members theo segment đang chọn.</div>
          </div>
          <div class="field" style="margin:0;">
            <label>Định dạng</label>
            <select id="exFormat">
              <option selected="">CSV</option>
              <option>XLSX</option>
            </select>
          </div>
          <div class="field" style="margin:0;">
            <label>Fields</label>
            <select id="exFields">
              <option selected="">Basic (Name, Phone, Email)</option>
              <option>Marketing (Opt-in, Tags, Last Activity)</option>
              <option>Sales (LTV, Orders, Avg Order)</option>
            </select>
          </div>
        </div>

        <div class="note">
          <b>Gợi ý kiểm soát dữ liệu:</b><br>
          • Khi export để chạy campaign, nên loại bỏ blacklist và các contact chưa opt-in<br>
          • Với phân khúc lớn, nên export theo batch (sắp phát triển)
        </div>
      </div>

      <div class="modal-foot">
        <button class="btn" data-action="close_modal"><i class="fa-solid fa-xmark"></i> Đóng</button>
        <button class="btn primary" data-action="do_export"><i class="fa-solid fa-download"></i> Export</button>
      </div>
    </div>
  </div>

  <script>
    function openPage(page, params = {}) {
      const qs = new URLSearchParams(params).toString();
      window.location.href = qs ? `${page}?${qs}` : page;
    }

    // ===== Sample data (mock) =====
    const segments = [
      {
        id:"SEG-001",
        name:"VIP Repeat Buyers (LTV ≥ 5M, 60 days)",
        type:"Dynamic",
        status:"Active",
        members: 1284,
        source:"E-commerce",
        lastRefreshHours: 3,
        desc:"Nhóm khách hàng mua lặp lại với giá trị cao. Dùng cho ưu đãi VIP / upsell combo.",
        rule:"LTV >= 5,000,000 AND Last Purchase <= 60 days AND Opt-in = TRUE",
        tags:["vip","repeat","high_ltv"],
        timeline:[
          {who:"Hệ thống", when:"09:40", msg:"Refresh segment thành công. Members: 1,284."},
          {who:"Marketing - Lan", when:"Hôm qua", msg:"Gắn tag 'vip' và cập nhật rule loại blacklist."}
        ]
      },
      {
        id:"SEG-004",
        name:"Dormant Customers (No purchase 180 days)",
        type:"Dynamic",
        status:"Active",
        members: 6720,
        source:"CRM",
        lastRefreshHours: 30,
        desc:"Khách hàng ngủ đông, cần chiến dịch win-back. Ưu tiên kênh ZNS/Email với ưu đãi nhẹ.",
        rule:"Last Purchase > 180 days AND Total Orders >= 1",
        tags:["dormant","winback"],
        timeline:[
          {who:"Hệ thống", when:"2 ngày", msg:"Refresh chậm do dữ liệu lớn, cần tối ưu rule."}
        ]
      },
      {
        id:"SEG-007",
        name:"HCM COD Risk (COD mismatch / missing POD)",
        type:"Dynamic",
        status:"Paused",
        members: 420,
        source:"Finance Risk",
        lastRefreshHours: 12,
        desc:"Segment phục vụ kiểm soát rủi ro COD. Chỉ dùng nội bộ, không chạy campaign.",
        rule:"City = 'HCM' AND (COD_MISMATCH = TRUE OR POD_MISSING = TRUE)",
        tags:["risk","cod"],
        timeline:[
          {who:"Ops - Hưng", when:"Hôm qua", msg:"Tạm dừng segment do rule cần thêm điều kiện loại trùng."}
        ]
      },
      {
        id:"SEG-009",
        name:"Manual List: Partners & Key Accounts (2026)",
        type:"Static",
        status:"Draft",
        members: 58,
        source:"Import",
        lastRefreshHours: 1,
        desc:"Danh sách đối tác & key accounts do team Sales cung cấp. Sẽ import theo file.",
        rule:"(Manual upload list)",
        tags:["key_account","partners"],
        timeline:[
          {who:"Sales Admin", when:"08:10", msg:"Tạo segment nháp, chờ file import."}
        ]
      },
      {
        id:"SEG-012",
        name:"Archived: Old Campaign Segment - Black Friday 2025",
        type:"Dynamic",
        status:"Archived",
        members: 0,
        source:"CRM",
        lastRefreshHours: 999,
        desc:"Segment cũ đã đóng, lưu để audit.",
        rule:"(Archived)",
        tags:["archived","bf2025"],
        timeline:[
          {who:"Hệ thống", when:"2025", msg:"Segment archived."}
        ]
      }
    ];

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);

    function pillClassForStatus(s){
      if(s === "Active") return "green";
      if(s === "Draft") return "gray";
      if(s === "Paused") return "yellow";
      if(s === "Archived") return "gray";
      return "gray";
    }
    function pillClassForType(t){
      if(t === "Dynamic") return "blue";
      return "purple";
    }
    function refreshLabel(hours){
      if(hours <= 6) return {txt: `${hours}h ago`, cls:"green"};
      if(hours <= 24) return {txt: `${hours}h ago`, cls:"blue"};
      if(hours <= 72) return {txt: `${hours}h ago`, cls:"yellow"};
      return {txt: `>72h`, cls:"red"};
    }
    function fmt(n){
      return new Intl.NumberFormat('vi-VN').format(n);
    }
    function nowHHMM(){
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      return `${hh}:${mm}`;
    }

    // ===== Status multi-select =====
    (function initMultiSelect(){
      const dd = $("statusDropdown");
      const selected = $("statusSelected");
      const opts = dd.querySelectorAll('input[type="checkbox"]');

      function updateSelectedLabel(){
        const checked = Array.from(opts).filter(o => o.checked).map(o => o.value);
        if(checked.length === opts.length) selected.textContent = "Tất cả";
        else if(checked.length === 0) selected.textContent = "Không chọn";
        else selected.textContent = checked.join(", ");
      }

      dd.addEventListener("click", (e) => {
        const isClickOnOption = e.target && (e.target.tagName === "INPUT" || e.target.tagName === "LABEL");
        if(!isClickOnOption){
          dd.classList.toggle("open");
        }
      });

      document.addEventListener("click", (e) => {
        if(!dd.contains(e.target)) dd.classList.remove("open");
      });

      opts.forEach(o => {
        o.addEventListener("change", () => {
          updateSelectedLabel();
          applyFilters();
        });
      });

      updateSelectedLabel();
    })();

    // ===== Rendering =====
    let activeId = null;
    window.activeId = null;

    function renderTable(list){
      const tb = $("segTbody");
      tb.innerHTML = list.map(s => {
        const st = `<span class="pill ${pillClassForStatus(s.status)}"><i class="fa-solid fa-circle"></i> ${s.status}</span>`;
        const ty = `<span class="pill ${pillClassForType(s.type)}"><i class="fa-solid fa-diagram-project"></i> ${s.type}</span>`;
        const rf = refreshLabel(s.lastRefreshHours);
        const refresh = `<span class="pill ${rf.cls}"><i class="fa-solid fa-rotate"></i> ${rf.txt}</span>`;
        const tags = (s.tags||[]).slice(0,3).map(t => `<span class="pill gray"><i class="fa-solid fa-tag"></i> ${t}</span>`).join(" ");

        const sub = `
          <div class="subline">
            <span><i class="fa-solid fa-database"></i> ${s.source}</span>
            ${tags ? `<span>•</span> ${tags}` : ``}
          </div>
        `;

        return `
          <tr data-id="${s.id}">
            <td><div class="id">${s.id}</div></td>
            <td class="name-cell">
              <span class="name-title">${s.name}</span>
              ${sub}
            </td>
            <td>${ty}</td>
            <td>${st}</td>
            <td><span class="pill gray"><i class="fa-solid fa-users"></i> ${fmt(s.members)}</span></td>
            <td>${refresh}</td>
            <td style="white-space:nowrap;">
              <span style="display:inline-flex;gap:10px;align-items:center;">
                <i class="fa-solid fa-eye" title="View" data-action="segment_view" data-id="${s.id}" style="color:var(--accent-blue);cursor:pointer"></i>
                <i class="fa-solid fa-pen-to-square" title="Edit" data-action="segment_edit" data-id="${s.id}" style="color:var(--text-muted);cursor:pointer"></i>
                <i class="fa-solid fa-box-archive" title="Archive" data-action="segment_archive" data-id="${s.id}" style="color:var(--danger);cursor:pointer"></i>
              </span>
            </td>
          </tr>
        `;
      }).join("");

      tb.querySelectorAll("tr").forEach(tr => {
        tr.addEventListener("click", () => {
          const id = tr.getAttribute("data-id");
          setActive(id, list);
        });
        tr.addEventListener("dblclick", () => {
          const id = tr.getAttribute("data-id");
          openPage("segmentation_detail.html", { id });
        });
      });
    }

    function setActive(id, currentList){
      activeId = id;
      window.activeId = id;

      document.querySelectorAll("#segTbody tr").forEach(r => r.classList.remove("active"));
      const row = document.querySelector(`#segTbody tr[data-id="${id}"]`);
      if(row) row.classList.add("active");

      const s = (currentList || segments).find(x => x.id === id) || segments.find(x => x.id === id);
      if(!s) return;

      $("crumbLive").innerHTML = `<i class="fa-solid fa-circle-info"></i> Đang xem <b>${s.id}</b> • <span class="pill ${pillClassForStatus(s.status)}" style="transform:translateY(-1px)"><i class="fa-solid fa-circle"></i> ${s.status}</span>`;

      $("pvId").innerHTML = `<span class="pill gray"><i class="fa-solid fa-layer-group"></i> ${s.id}</span>`;
      $("pvStatus").innerHTML = `<span class="pill ${pillClassForStatus(s.status)}"><i class="fa-solid fa-circle"></i> ${s.status}</span>`;
      $("pvType").innerHTML = `<span class="pill ${pillClassForType(s.type)}"><i class="fa-solid fa-diagram-project"></i> ${s.type}</span>`;
      $("pvMembers").innerHTML = `<span class="pill gray"><i class="fa-solid fa-users"></i> ${fmt(s.members)}</span>`;
      $("pvSource").innerHTML = `<span class="pill gray"><i class="fa-solid fa-database"></i> ${s.source}</span>`;

      const rf = refreshLabel(s.lastRefreshHours);
      $("pvRefresh").innerHTML = `<span class="pill ${rf.cls}"><i class="fa-solid fa-rotate"></i> ${rf.txt}</span>`;

      $("pvDesc").textContent = s.desc || "—";
      $("pvRule").innerHTML = `• ${s.rule || "(No rule)"}`;

      $("exSegment").value = `${s.id} • ${s.name}`;

      $("pvTimeline").innerHTML = (s.timeline || []).map(x => `
        <div class="mini-item">
          <div class="mini-dot" style="background:${(x.who||"").includes('Hệ thống') ? 'var(--purple)' : 'var(--accent-blue)'}"></div>
          <div class="mini-content">
            <div class="top">
              <div class="who">${x.who}</div>
              <div class="when">${x.when}</div>
            </div>
            <div class="msg">${x.msg}</div>
          </div>
        </div>
      `).join("");

      // hints
      const hint = [];
      if(s.type === "Dynamic") hint.push("• Segment Dynamic: nên lên lịch refresh theo ngày/giờ để data luôn mới.");
      else hint.push("• Segment Static: nhớ import lại file khi có danh sách mới.");
      if(s.status === "Paused") hint.push("• Segment đang Paused — kiểm tra rule hoặc nguồn dữ liệu trước khi bật lại.");
      if(s.members > 5000) hint.push("• Members lớn — cân nhắc chia nhỏ theo khu vực hoặc hành vi để tối ưu campaign.");
      hint.push("• Khi chạy campaign: check opt-in + blacklist + frequency cap.");
      $("pvHint").innerHTML = hint.join("<br/>");
    }

    function setEmptyPreview(){
      activeId = null;
      window.activeId = null;
      $("crumbLive").innerHTML = `<i class="fa-solid fa-circle-info"></i> Chọn 1 segment để xem nhanh`;
      ["pvId","pvStatus","pvType","pvMembers","pvSource","pvRefresh"].forEach(id => $(id).textContent = "—");
      $("pvDesc").textContent = "Không có segment phù hợp bộ lọc hiện tại.";
      $("pvTimeline").innerHTML = `
        <div class="mini-item">
          <div class="mini-dot"></div>
          <div class="mini-content">
            <div class="top">
              <div class="who">Hệ thống</div>
              <div class="when">—</div>
            </div>
            <div class="msg">Không có dữ liệu.</div>
          </div>
        </div>`;
      $("pvHint").innerHTML = "• Hãy điều chỉnh bộ lọc để tìm segment cần thao tác.";
      $("exSegment").value = "—";
    }

    function updateStats(list){
      const total = list.length;
      const active = list.filter(s => s.status === "Active").length;
      const members = list.reduce((sum, s) => sum + (s.members || 0), 0);
      const stale = list.filter(s => s.lastRefreshHours > 24).length;
      const ready = list.filter(s => s.type === "Dynamic" && s.status === "Active").length;

      $("statSegments").textContent = total;
      $("statActiveSub").textContent = `Active: ${active}`;

      $("statMembers").textContent = fmt(members);
      $("statMembersSub").textContent = `7 ngày: +${fmt(Math.max(120, Math.round(members*0.02)))}`;

      $("statStale").textContent = stale;
      $("statStaleSub").textContent = `> 24h: ${stale}`;

      $("statReady").textContent = ready;
      $("statReadySub").textContent = `Có rule: ${ready}`;
    }

    function applyFilters(){
      const q = ($("q").value || "").trim().toLowerCase();
      const type = $("type").value;
      const source = $("source").value;
      const refresh = $("refresh").value;

      const checkedStatuses = Array.from(document.querySelectorAll('#statusOptions input[type="checkbox"]'))
        .filter(x => x.checked).map(x => x.value);

      const filtered = segments.filter(s => {
        const matchQ = !q || (
          s.id.toLowerCase().includes(q) ||
          s.name.toLowerCase().includes(q) ||
          (s.tags || []).some(t => t.toLowerCase().includes(q))
        );
        const matchStatus = checkedStatuses.includes(s.status);
        const matchType = !type || (type.startsWith("Dynamic") ? s.type === "Dynamic" : s.type === "Static");
        const matchSource = !source || s.source === source;
        const matchRefresh = refresh === "all" ? true : (refresh === "fresh" ? s.lastRefreshHours <= 24 : s.lastRefreshHours > 24);
        return matchQ && matchStatus && matchType && matchSource && matchRefresh;
      });

      renderTable(filtered);
      updateStats(filtered);

      $("resultCount").innerHTML = `<i class="fa-solid fa-filter"></i> ${filtered.length} segment`;
      $("lastSync").innerHTML = `<i class="fa-regular fa-clock"></i> Cập nhật ${nowHHMM()}`;

      if(activeId && filtered.some(x => x.id === activeId)){
        const row = document.querySelector(`tr[data-id="${activeId}"]`);
        if(row) row.classList.add("active");
        setActive(activeId, filtered);
      } else {
        if(filtered.length) setActive(filtered[0].id, filtered);
        else setEmptyPreview();
      }
    }

    // ===== Router for future pages (.html) =====
    document.addEventListener('click', (e) => {
      const el = e.target.closest('[data-action]');
      if(!el) return;

      const action = el.dataset.action;
      const id = el.dataset.id || window.activeId;

      if(action === 'segment_new') return openPage('segmentation_create.html');
      if(action === 'segment_export') return openExportModal();
      if(action === 'segment_import') return openPage('segmentation_import.html');
      if(action === 'segment_rules') return openPage('segment_rules.html', { id: id || "" });

      if(action === 'segment_view') return openPage('segmentation_detail.html', { id: id || "" });
      if(action === 'segment_edit') return openPage('segmentation_edit.html', { id: el.dataset.id || "" });
      if(action === 'segment_archive') return openPage('segmentation_archive.html', { id: el.dataset.id || "" });

      if(action === 'create_campaign') return openPage('campaign_create.html', { segment: id || "" });
      if(action === 'refresh_segment') return openPage('segment_refresh.html', { id: id || "" });

      if(action === 'close_modal') return closeExportModal();
      if(action === 'do_export') return doExport();
    });

    function openExportModal(){
      if(!window.activeId){
        alert("Hãy chọn 1 segment để export.");
        return;
      }
      $("exportModal").classList.add("open");
      $("exportModal").setAttribute("aria-hidden", "false");
    }
    function closeExportModal(){
      $("exportModal").classList.remove("open");
      $("exportModal").setAttribute("aria-hidden", "true");
    }
    function doExport(){
      // mock only
      const fmt = $("exFormat").value;
      alert(`Export (mock): ${$("exSegment").value} • ${fmt}`);
      closeExportModal();
    }

    // close modal on backdrop click
    $("exportModal").addEventListener("click", (e) => {
      if(e.target === $("exportModal")) closeExportModal();
    });

    // Bind filters
    ["q","type","source","refresh"].forEach(id => {
      $(id).addEventListener("input", applyFilters);
      $(id).addEventListener("change", applyFilters);
    });

    $("btnRefresh").addEventListener("click", () => applyFilters());

    // Init
    applyFilters();
  </script>


</body></html>
